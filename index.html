<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Pasticceria con Foodcost</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        .container {
            width: 80%;
            margin: auto;
            overflow: hidden;
            padding: 20px;
        }
        header {
            background: #50b3a2;
            color: white;
            padding-top: 30px;
            min-height: 70px;
            border-bottom: #e8491d 3px solid;
        }
        header a {
            color: #ffffff;
            text-decoration: none;
            text-transform: uppercase;
            font-size: 16px;
        }
        header ul {
            padding: 0;
            margin: 0;
            list-style: none;
            overflow: hidden;
        }
        header li {
            float: left;
            display: inline;
            padding: 0 20px 0 20px;
        }
        header #branding {
            float: left;
        }
        header #branding h1 {
            margin: 0;
        }
        header nav {
            float: right;
            margin-top: 10px;
        }
        header .highlight, header .current a {
            color: #e8491d;
            font-weight: bold;
        }
        header a:hover {
            color: #ffffff;
            font-weight: bold;
        }
        .main-content {
            padding: 20px;
            background: white;
            margin-top: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
        }
        form {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        input[type="text"], input[type="number"], input[type="date"], select, textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background: #50b3a2;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        button:hover {
            background: #3a8279;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #50b3a2;
            color: white;
        }
        .notification {
            padding: 10px;
            background-color: #f44336;
            color: white;
            margin-bottom: 15px;
            border-radius: 4px;
            display: none;
        }
        .fade-in {
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div id="branding">
                <h1><span class="highlight">Pasticceria</span> Manager</h1>
            </div>
            <nav>
                <ul>
                    <li><a href="#" onclick="mostraSezione('lotti')">Lotti</a></li>
                    <li><a href="#" onclick="mostraSezione('etichette')">Etichette</a></li>
                    <li><a href="#" onclick="mostraSezione('magazzino')">Magazzino</a></li>
                    <li><a href="#" onclick="mostraSezione('ricette')">Ricette</a></li>
                    <li><a href="#" onclick="mostraSezione('foodcost')">Foodcost</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container">
        <div id="notification" class="notification"></div>
        
        <section id="lotti" class="main-content">
            <h2>Generatore di Lotti</h2>
            <form id="lottoForm">
                <input type="text" id="prodotto" placeholder="Nome Prodotto" required>
                <input type="date" id="dataProduzione" required>
                <input type="date" id="dataScadenza" required>
                <input type="number" id="quantita" placeholder="Quantit√†" required>
                <button type="submit">Genera Lotto</button>
            </form>
            <table id="lottiTable">
                <tr>
                    <th>ID Lotto</th>
                    <th>Prodotto</th>
                    <th>Data Produzione</th>
                    <th>Data Scadenza</th>
                    <th>Quantit√†</th>
                </tr>
            </table>
        </section>

        <section id="etichette" class="main-content" style="display:none;">
            <h2>Generatore di Etichette</h2>
            <form id="etichettaForm">
                <select id="lottoSelect">
                    <option value="">Seleziona un lotto</option>
                </select>
                <textarea id="ingredienti" placeholder="Ingredienti" rows="4"></textarea>
                <textarea id="allergeni" placeholder="Allergeni" rows="2"></textarea>
                <input type="number" id="quantitaNetta" placeholder="Quantit√† Netta (g)" required>
                <input type="number" id="quantitaNettaOz" placeholder="Quantit√† Netta (oz)" required>
                <textarea id="condizioniConservazione" placeholder="Condizioni di Conservazione" rows="2"></textarea>
                <input type="text" id="produttore" placeholder="Nome e Indirizzo del Produttore" required>
                <input type="text" id="paeseOrigine" placeholder="Paese di Origine" required>
                <textarea id="dichiarazioneNutrizionale" placeholder="Dichiarazione Nutrizionale (per 100g)" rows="6"></textarea>
                <input type="text" id="logoUrl" placeholder="URL del logo (opzionale)">
                <button type="submit">Genera Etichetta PDF</button>
            </form>
            <div id="etichettaPreview" style="border: 1px solid #ddd; padding: 20px; margin-top: 20px;"></div>
        </section>

        <section id="magazzino" class="main-content" style="display:none;">
            <h2>Gestione Magazzino</h2>
            <form id="magazzinoForm">
                <input type="text" id="ingrediente" placeholder="Nome Ingrediente" required>
                <input type="number" id="quantitaIngrediente" placeholder="Quantit√† (g)" required>
                <input type="date" id="scadenzaIngrediente" required>
                <input type="number" id="quantitaMinima" placeholder="Quantit√† Minima (g)" required>
                <input type="number" id="prezzoIngrediente" placeholder="Prezzo per kg" required>
                <button type="submit">Aggiungi/Aggiorna Ingrediente</button>
            </form>
            <table id="magazzinoTable">
                <tr>
                    <th>Ingrediente</th>
                    <th>Quantit√† (g)</th>
                    <th>Scadenza</th>
                    <th>Quantit√† Minima (g)</th>
                    <th>Prezzo per kg</th>
                </tr>
            </table>
        </section>

        <section id="ricette" class="main-content" style="display:none;">
            <h2>Gestione Ricette</h2>
            <form id="ricettaForm">
                <input type="text" id="nomeRicetta" placeholder="Nome Ricetta" required>
                <div id="ingredientiRicetta"></div>
                <button type="button" onclick="aggiungiIngredienteRicetta()">Aggiungi Ingrediente</button>
                <input type="number" id="pesoTotaleAtteso" placeholder="Peso totale atteso (g)" required>
                <input type="number" id="costoManodopera" placeholder="Costo manodopera" required>
                <input type="number" id="costoPackaging" placeholder="Costo packaging" required>
                <input type="number" id="altriCosti" placeholder="Altri costi" required>
                <button type="submit">Salva Ricetta</button>
            </form>
            <table id="ricetteTable">
                <tr>
                    <th>Nome Ricetta</th>
                    <th>Ingredienti</th>
                    <th>Peso Totale (g)</th>
                    <th>Resa (%)</th>
                    <th>Costo Totale</th>
                </tr>
            </table>
        </section>

        <section id="foodcost" class="main-content" style="display:none;">
            <h2>Calcolo Foodcost</h2>
            <form id="foodcostForm">
                <select id="ricettaSelect">
                    <option value="">Seleziona una ricetta</option>
                </select>
                <input type="number" id="percentualeInvenduto" placeholder="Percentuale invenduto (%)" required>
                <input type="number" id="percentualeProfitto" placeholder="Percentuale profitto desiderato (%)" required>
                <button type="submit">Calcola Foodcost</button>
            </form>
            <div id="foodcostResult"></div>
        </section>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
    <script>
        let lotti = [];
        let magazzino = [];
        let ricette = [];

        function generaIdLotto() {
            return 'L' + Date.now();
        }

        function mostraSezione(sezione) {
            document.querySelectorAll('.main-content').forEach(section => section.style.display = 'none');
            document.getElementById(sezione).style.display = 'block';
        }

        function aggiungiLotto(event) {
            event.preventDefault();
            const lotto = {
                id: generaIdLotto(),
                prodotto: document.getElementById('prodotto').value,
                dataProduzione: document.getElementById('dataProduzione').value,
                dataScadenza: document.getElementById('dataScadenza').value,
                quantita: parseFloat(document.getElementById('quantita').value)
            };
            lotti.push(lotto);
            aggiornaTabellaLotti();
            aggiornaSelettoreLotti();
            mostraNotifica('Lotto aggiunto con successo!', 'success');
            document.getElementById('lottoForm').reset();
        }

        function aggiornaTabellaLotti() {
            const table = document.getElementById('lottiTable');
            table.innerHTML = `
                <tr>
                    <th>ID Lotto</th>
                    <th>Prodotto</th>
                    <th>Data Produzione</th>
                    <th>Data Scadenza</th>
                    <th>Quantit√†</th>
                </tr>`;
            lotti.forEach(lotto => {
                const row = table.insertRow();
                row.insertCell(0).textContent = lotto.id;
                row.insertCell(1).textContent = lotto.prodotto;
                row.insertCell(2).textContent = lotto.dataProduzione;
                row.insertCell(3).textContent = lotto.dataScadenza;
                row.insertCell(4).textContent = lotto.quantita;
            });
        }

        function aggiornaSelettoreLotti() {
            const select = document.getElementById('lottoSelect');
            select.innerHTML = '<option value="">Seleziona un lotto</option>';
            lotti.forEach(lotto => {
                const option = document.createElement('option');
                option.value = lotto.id;
                option.textContent = `${lotto.prodotto} - ${lotto.id}`;
                select.appendChild(option);
            });
        }

        function generaEtichetta(event) {
            event.preventDefault();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: [100, 150]
            });

            const lottoId = document.getElementById('lottoSelect').value;
            const lotto = lotti.find(l => l.id === lottoId);
            const ingredienti = document.getElementById('ingredienti').value;
            const allergeni = document.getElementById('allergeni').value;
            const quantitaNetta = document.getElementById('quantitaNetta').value;
            const quantitaNettaOz = document.getElementById('quantitaNettaOz').value;
            const condizioniConservazione = document.getElementById('condizioniConservazione').value;
            const produttore = document.getElementById('produttore').value;
            const paeseOrigine = document.getElementById('paeseOrigine').value;
            const dichiarazioneNutrizionale = document.getElementById('dichiarazioneNutrizionale').value;
            const logoUrl = document.getElementById('logoUrl').value;

            doc.setFillColor(255, 255, 255);
            doc.rect(0, 0, 150, 100, 'F');

            doc.setDrawColor(0);
            doc.setLineWidth(0.5);
            doc.rect(5, 5, 140, 90);

            if (logoUrl) {
                doc.addImage(logoUrl, 'JPEG', 10, 10, 20, 20);
            }

            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            doc.text(`${lotto.prodotto}`, 75, 15, { align: 'center' });

            doc.setFontSize(14);
            doc.text(`${quantitaNetta}g / ${quantitaNettaOz}oz`, 75, 22, { align: 'center' });

            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            let yPos = 30;
            doc.text(`Ingredienti: ${ingredienti}`, 10, yPos);
            yPos += 10;
            doc.text(`Allergeni: ${allergeni}`, 10, yPos);
            yPos += 5;
            doc.text(`Da consumarsi preferibilmente entro il: ${lotto.dataScadenza}`, 10, yPos);
            yPos += 5;
            doc.text(`Condizioni di Conservazione: ${condizioniConservazione}`, 10, yPos);
            yPos += 5;
            doc.text(`Prodotto e confezionato da: ${produttore}`, 10, yPos);
            yPos += 5;
            doc.text(`Paese di Origine: ${paeseOrigine}`, 10, yPos);

            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text("Valori nutrizionali medi per 100g:", 80, 30);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            const nutrizioneLinee = dichiarazioneNutrizionale.split('\n');
            let yPosNutrizione = 35;
            nutrizioneLinee.forEach(linea => {
                doc.text(linea, 80, yPosNutrizione);
                yPosNutrizione += 4;
            });

            const canvas = document.createElement('canvas');
            JsBarcode(canvas, lotto.id, {
                format: "CODE128",
                width: 2,
                height: 30,
                displayValue: false
            });
            const imgData = canvas.toDataURL("image/png");
            doc.addImage(imgData, 'PNG', 10, 70, 50, 20);

            doc.setFontSize(8);
            doc.text(`Lotto: ${lotto.id}`, 10, 95);
            doc.text(`Data di produzione: ${lotto.dataProduzione}`, 50, 95);

            doc.setFontSize(12);
            doc.text("‚ôª", 130, 90);
            doc.text("üå±", 135, 90);
            doc.text("üì¶", 140, 90);

            doc.save(`${lotto.prodotto}_etichetta.pdf`);
            mostraNotifica('Etichetta generata con successo!', 'success');
        }

        function mostraNotifica(messaggio, tipo) {
            const notification = document.getElementById('notification');
            notification.textContent = messaggio;
            notification.className = `notification ${tipo} fade-in`;
            notification.style.display = 'block';
            setTimeout(() => notification.style.display = 'none', 3000);
        }

        function aggiungiIngredienteMagazzino(event) {
            event.preventDefault();
            const ingrediente = {
                nome: document.getElementById('ingrediente').value,
                quantita: parseFloat(document.getElementById('quantitaIngrediente').value),
                scadenza: document.getElementById('scadenzaIngrediente').value,
                quantitaMinima: parseFloat(document.getElementById('quantitaMinima').value),
                prezzo: parseFloat(document.getElementById('prezzoIngrediente').value)
            };
            const index = magazzino.findIndex(item => item.nome === ingrediente.nome);
            if (index !== -1) {
                magazzino[index] = ingrediente;
            } else {
                magazzino.push(ingrediente);
            }
            aggiornaTabellaIngrediente();
            mostraNotifica('Ingrediente aggiunto/aggiornato con successo!', 'success');
            document.getElementById('magazzinoForm').reset();
        }

        function aggiornaTabellaIngrediente() {
            const table = document.getElementById('magazzinoTable');
            table.innerHTML = `
                <tr>
                    <th>Ingrediente</th>
                    <th>Quantit√† (g)</th>
                    <th>Scadenza</th>
                    <th>Quantit√† Minima (g)</th>
                    <th>Prezzo per kg</th>
                </tr>`;
            magazzino.forEach(ingrediente => {
                const row = table.insertRow();
                row.insertCell(0).textContent = ingrediente.nome;
                row.insertCell(1).textContent = ingrediente.quantita;
                row.insertCell(2).textContent = ingrediente.scadenza;
                row.insertCell(3).textContent = ingrediente.quantitaMinima;
                row.insertCell(4).textContent = ingrediente.prezzo;
            });
        }

        function aggiungiIngredienteRicetta() {
            const container = document.getElementById('ingredientiRicetta');
            const div = document.createElement('div');
            div.innerHTML = `
                <select class="ingredienteSelect">
                    <option value="">Seleziona un ingrediente</option>
                    ${magazzino.map(ing => `<option value="${ing.nome}">${ing.nome}</option>`).join('')}
                </select>
                <input type="number" class="quantitaIngredienteRicetta" placeholder="Quantit√† (g)" required>
            `;
            container.appendChild(div);
        }

        function salvaRicetta(event) {
            event.preventDefault();
            const nomeRicetta = document.getElementById('nomeRicetta').value;
            const ingredienti = Array.from(document.querySelectorAll('#ingredientiRicetta > div')).map(div => ({
                nome: div.querySelector('.ingredienteSelect').value,
                quantita: parseFloat(div.querySelector('.quantitaIngredienteRicetta').value)
            }));
            const pesoTotaleAtteso = parseFloat(document.getElementById('pesoTotaleAtteso').value);
            const pesoTotaleEffettivo = ingredienti.reduce((total, ing) => total + ing.quantita, 0);
            const resa = (pesoTotaleEffettivo / pesoTotaleAtteso) * 100;
            const percentualeScarto = 100 - resa;

            const ricetta = {
                nome: nomeRicetta,
                ingredienti: ingredienti,
                pesoTotaleAtteso: pesoTotaleAtteso,
                pesoTotaleEffettivo: pesoTotaleEffettivo,
                resa: resa,
                percentualeScarto: percentualeScarto,
                costoManodopera: parseFloat(document.getElementById('costoManodopera').value),
                costoPackaging: parseFloat(document.getElementById('costoPackaging').value),
                altriCosti: parseFloat(document.getElementById('altriCosti').value)
            };
            ricette.push(ricetta);
            aggiornaTabellaRicette();
            aggiornaSelettoreRicette();
            mostraNotifica('Ricetta salvata con successo!', 'success');
            document.getElementById('ricettaForm').reset();
            document.getElementById('ingredientiRicetta').innerHTML = '';
        }

        function aggiornaTabellaRicette() {
            const table = document.getElementById('ricetteTable');
            table.innerHTML = `
                <tr>
                    <th>Nome Ricetta</th>
                    <th>Ingredienti</th>
                    <th>Peso Totale (g)</th>
                    <th>Resa (%)</th>
                    <th>Costo Totale</th>
                </tr>`;
            ricette.forEach(ricetta => {
                const row = table.insertRow();
                row.insertCell(0).textContent = ricetta.nome;
                row.insertCell(1).textContent = ricetta.ingredienti.map(ing => `${ing.nome} (${ing.quantita}g)`).join(', ');
                row.insertCell(2).textContent = ricetta.pesoTotaleEffettivo.toFixed(2);
                row.insertCell(3).textContent = ricetta.resa.toFixed(2);
                const costoTotale = calcolaCostoTotaleRicetta(ricetta);
                row.insertCell(4).textContent = `‚Ç¨${costoTotale.toFixed(2)}`;
            });
        }

        function aggiornaSelettoreRicette() {
            const select = document.getElementById('ricettaSelect');
            select.innerHTML = '<option value="">Seleziona una ricetta</option>';
            ricette.forEach(ricetta => {
                const option = document.createElement('option');
                option.value = ricetta.nome;
                option.textContent = ricetta.nome;
                select.appendChild(option);
            });
        }

        function calcolaCostoTotaleRicetta(ricetta) {
            const costoIngredienti = ricetta.ingredienti.reduce((total, ing) => {
                const ingredienteMagazzino = magazzino.find(i => i.nome === ing.nome);
                const costoIngrediente = ingredienteMagazzino ? (ingredienteMagazzino.prezzo / 1000) * ing.quantita : 0;
                return total + costoIngrediente;
            }, 0);
            return costoIngredienti + ricetta.costoManodopera + ricetta.costoPackaging + ricetta.altriCosti;
        }

        function calcolaFoodcost(event) {
            event.preventDefault();
            const nomeRicetta = document.getElementById('ricettaSelect').value;
            const ricetta = ricette.find(r => r.nome === nomeRicetta);
            if (!ricetta) {
                mostraNotifica('Seleziona una ricetta valida', 'error');
                return;
            }
            const percentualeInvenduto = parseFloat(document.getElementById('percentualeInvenduto').value) / 100;
            const percentualeProfitto = parseFloat(document.getElementById('percentualeProfitto').value) / 100;

            const costoTotale = calcolaCostoTotaleRicetta(ricetta);
            const costoPerGrammo = costoTotale / ricetta.pesoTotaleEffettivo;
            const costoConScarto = costoPerGrammo / (ricetta.resa / 100);
            const costoConInvenduto = costoConScarto / (1 - percentualeInvenduto);
            const prezzoVendita = costoConInvenduto / (1 - percentualeProfitto);

            const risultato = document.getElementById('foodcostResult');
            risultato.innerHTML = `
                <h3>Risultato Foodcost per ${ricetta.nome}</h3>
                <p>Costo totale ricetta: ‚Ç¨${costoTotale.toFixed(2)}</p>
                <p>Costo per grammo: ‚Ç¨${costoPerGrammo.toFixed(4)}/g</p>
                <p>Costo considerando lo scarto (${ricetta.percentualeScarto.toFixed(2)}%): ‚Ç¨${costoConScarto.toFixed(4)}/g</p>
                <p>Costo considerando l'invenduto (${(percentualeInvenduto * 100).toFixed(2)}%): ‚Ç¨${costoConInvenduto.toFixed(4)}/g</p>
                <p>Prezzo di vendita consigliato: ‚Ç¨${prezzoVendita.toFixed(2)}/g</p>
                <p>Prezzo di vendita per porzione (100g): ‚Ç¨${(prezzoVendita * 100).toFixed(2)}</p>
                <p>Margine di profitto: ‚Ç¨${(prezzoVendita - costoConInvenduto).toFixed(4)}/g</p>
            `;
        }

        document.getElementById('lottoForm').addEventListener('submit', aggiungiLotto);
        document.getElementById('etichettaForm').addEventListener('submit', generaEtichetta);
        document.getElementById('magazzinoForm').addEventListener('submit', aggiungiIngredienteMagazzino);
        document.getElementById('ricettaForm').addEventListener('submit', salvaRicetta);
        document.getElementById('foodcostForm').addEventListener('submit', calcolaFoodcost);
    </script>
</body>
</html>
