<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Promemoria</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.0.0/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .dark-mode {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .dark-mode .container {
            background-color: #2d3748;
            color: #e2e8f0;
        }
        .dark-mode .input-group input,
        .dark-mode .input-group select,
        .dark-mode .input-group textarea {
            background-color: #2d3748;
            color: #e2e8f0;
            border-color: #4a5568;
        }
    </style>
</head>
<body>
    <div class="container mx-auto p-6 bg-white rounded-lg shadow-lg dark-mode">
        <h1 class="text-3xl font-bold text-center mb-4">Gestione Promemoria</h1>
        <button id="theme-toggle" class="mb-4 px-4 py-2 bg-blue-500 text-white rounded-lg focus:outline-none">Passa al Tema Scuro</button>
        
        <div class="input-group mb-4">
            <label for="reminder-text" class="block text-sm font-medium mb-2">Promemoria:</label>
            <input type="text" id="reminder-text" placeholder="Inserisci il tuo promemoria" class="w-full p-2 border border-gray-300 rounded-md">
        </div>
        
        <div class="input-group mb-4">
            <label for="reminder-date" class="block text-sm font-medium mb-2">Data e Ora:</label>
            <input type="datetime-local" id="reminder-date" class="w-full p-2 border border-gray-300 rounded-md">
        </div>
        
        <div class="input-group mb-4">
            <label for="reminder-icon" class="block text-sm font-medium mb-2">Icona:</label>
            <select id="reminder-icon" class="w-full p-2 border border-gray-300 rounded-md">
                <option value="📝">📝 Nota</option>
                <option value="🎉">🎉 Celebrazione</option>
                <option value="🏋️">🏋️ Esercizio</option>
                <option value="🍽️">🍽️ Pasto</option>
                <option value="💼">💼 Lavoro</option>
                <option value="🎁">🎁 Regalo</option>
            </select>
        </div>
        
        <div class="input-group mb-4">
            <label for="reminder-category" class="block text-sm font-medium mb-2">Categoria:</label>
            <select id="reminder-category" class="w-full p-2 border border-gray-300 rounded-md">
                <option value="lavoro">Lavoro</option>
                <option value="personale">Personale</option>
                <option value="salute">Salute</option>
                <option value="finanze">Finanze</option>
            </select>
        </div>

        <div class="input-group mb-4">
            <label for="reminder-priority" class="block text-sm font-medium mb-2">Priorità:</label>
            <select id="reminder-priority" class="w-full p-2 border border-gray-300 rounded-md">
                <option value="bassa">Bassa</option>
                <option value="media">Media</option>
                <option value="alta">Alta</option>
            </select>
        </div>
        
        <button onclick="addReminder()" class="px-4 py-2 bg-blue-500 text-white rounded-lg focus:outline-none">Aggiungi Promemoria</button>
        
        <div class="search-bar mt-6 mb-4">
            <input type="text" id="search-reminder" placeholder="Cerca promemoria" onkeyup="filterReminders()" class="w-full p-2 border border-gray-300 rounded-md">
        </div>
        
        <div id="reminders-list" class="mt-4"></div>
    </div>

    <script>
        const themeToggle = document.getElementById('theme-toggle');
        const body = document.body;

        themeToggle.addEventListener('click', () => {
            body.classList.toggle('dark-mode');
            themeToggle.textContent = body.classList.contains('dark-mode') ? 'Passa al Tema Chiaro' : 'Passa al Tema Scuro';
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js').then(reg => {
                console.log('Service Worker registrato con successo:', reg);
                return reg.pushManager.getSubscription();
            }).then(subscription => {
                if (subscription === null) {
                    console.log('Non sei iscritto alle notifiche.');
                } else {
                    console.log('Sei già iscritto alle notifiche:', subscription);
                }
            }).catch(error => {
                console.error('Registrazione del Service Worker fallita:', error);
            });
        }

        let reminders = JSON.parse(localStorage.getItem('reminders')) || [];

        function renderReminders() {
            const remindersList = document.getElementById('reminders-list');
            remindersList.innerHTML = '';
            reminders.forEach(reminder => {
                const reminderItem = document.createElement('div');
                reminderItem.className = `reminder-item ${reminder.completed ? 'completed' : ''} p-4 mb-2 border border-gray-300 rounded-md bg-white dark:bg-gray-700 dark:border-gray-600 flex justify-between items-center`;
                reminderItem.innerHTML = `
                    <div class="text">${reminder.icon} ${reminder.text} <span class="text-gray-500">(${new Date(reminder.date).toLocaleString()})</span></div>
                    <div class="flex space-x-2">
                        <button onclick="toggleComplete(${reminder.id})" class="px-3 py-1 bg-green-500 text-white rounded-lg focus:outline-none">${reminder.completed ? 'Non Completato' : 'Completa'}</button>
                        <button onclick="deleteReminder(${reminder.id})" class="px-3 py-1 bg-red-500 text-white rounded-lg focus:outline-none">Elimina</button>
                    </div>
                `;
                remindersList.appendChild(reminderItem);
            });
        }

        function addReminder() {
            const text = document.getElementById('reminder-text').value;
            const date = document.getElementById('reminder-date').value;
            const icon = document.getElementById('reminder-icon').value;
            const category = document.getElementById('reminder-category').value;
            const priority = document.getElementById('reminder-priority').value;

            if (!text || !date) {
                alert('Per favore, compila tutti i campi');
                return;
            }

            const reminder = {
                id: Date.now(),
                text,
                date: new Date(date).toISOString(),
                icon,
                category,
                priority,
                completed: false
            };

            reminders.push(reminder);
            localStorage.setItem('reminders', JSON.stringify(reminders));
            renderReminders();

            const reminderDate = new Date(date);
            const now = new Date();
            const timeUntilReminder = reminderDate - now;

            if (timeUntilReminder > 0) {
                setTimeout(() => {
                    sendNotification(reminder);
                }, timeUntilReminder);
            }
        }

        function sendNotification(reminder) {
            if (Notification.permission === 'granted') {
                navigator.serviceWorker.getRegistration().then(reg => {
                    reg.showNotification(`${reminder.icon} Promemoria`, {
                        body: reminder.text,
                        icon: 'path_to_icon.png'
                    });
                });
            }
        }

        function toggleComplete(id) {
            const reminder = reminders.find(r => r.id === id);
            if (reminder) {
                reminder.completed = !reminder.completed;
                localStorage.setItem('reminders', JSON.stringify(reminders));
                renderReminders();
            }
        }

        function deleteReminder(id) {
            reminders = reminders.filter(r => r.id !== id);
            localStorage.setItem('reminders', JSON.stringify(reminders));
            renderReminders();
        }

        function filterReminders() {
            const searchText = document.getElementById('search-reminder').value.toLowerCase();
            const filteredReminders = reminders.filter(reminder =>
                reminder.text.toLowerCase().includes(searchText)
            );
            const remindersList = document.getElementById('reminders-list');
            remindersList.innerHTML = '';
            filteredReminders.forEach(reminder => {
                const reminderItem = document.createElement('div');
                reminderItem.className = `reminder-item ${reminder.completed ? 'completed' : ''} p-4 mb-2 border border-gray-300 rounded-md bg-white dark:bg-gray-700 dark:border-gray-600 flex justify-between items-center`;
                reminderItem.innerHTML = `
                    <div class="text">${reminder.icon} ${reminder.text} <span class="text-gray-500">(${new Date(reminder.date).toLocaleString()})</span></div>
                    <div class="flex space-x-2">
                        <button onclick="toggleComplete(${reminder.id})" class="px-3 py-1 bg-green-500 text-white rounded-lg focus:outline-none">${reminder.completed ? 'Non Completato' : 'Completa'}</button>
                        <button onclick="deleteReminder(${reminder.id})" class="px-3 py-1 bg-red-500 text-white rounded-lg focus:outline-none">Elimina</button>
                    </div>
                `;
                remindersList.appendChild(reminderItem);
            });
        }

        if (Notification.permission !== 'granted') {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    console.log('Permesso per le notifiche concesso');
                } else {
                    console.log('Permesso per le notifiche negato');
                }
            });
        }

        renderReminders();
    </script>
</body>
</html>
